
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="author" content="Mun Mun Das">

  
  <meta name="description" content="HWIOAuthBundle is a great Symfony2 bundle that provides way to integrate web services that implements OAuth1.0 and OAuth2 as user authentication &hellip;">
  <meta name="keywords" content="PHP, Symfony, Laravel, Javascript">


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://m2mdas.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45815026-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/"></a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:m2mdas.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/21/integrate-hwioauthbundle-with-fosuserbundle/">Integrate HWIOAuthBundle With FOSUserBundle</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-21T20:22:00+06:00" pubdate data-updated="true">Nov 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/hwi/HWIOAuthBundle">HWIOAuthBundle</a> is a great Symfony2 bundle that provides way to integrate web services that implements OAuth1.0 and OAuth2 as user authentication system. Once configured you can add infinite amount of web services as authentication source.</p>

<p>After user authentication it is better to fetch user information from the web service and store them in so that the user does not have to input profile information again. In following section I will outline step by step instruction on how to configure <code>HWIOAuthBundle</code> and integrate <code>FOSUserBundle</code> user provider using <code>fosub_bridge</code> implemented in <code>HWIOauthBundle</code>. For web service Github OAuth api used.</p>

<p><code>HWIOAuthBundle</code> uses <a href="https://github.com/kriswallsmith/Buzz">Buzz</a> curl client to communicate with web services. <code>Buzz</code> by default enables SSL certificate check. On some server CA certificate information may not exist. To add CA certificate info download  <code>cacert.pem</code> from <a href="http://curl.haxx.se/docs/caextract.html">this</a> page and set <code>curl.cainfo</code> php ini variable to the location of <code>cacert.pem</code> e.g</p>

<figure class='code'><figcaption><span>php.ini </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="na">curl.cainfo</span> <span class="o">=</span> <span class="s">/path/to/cacert.pem</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then register application of the web service you want to use for authentication. For this post I have used Github for its simplicity. You can create application from <a href="https://github.com/settings/applications/new">here</a>. Your registration form may look like following,</p>

<p><img src="http://i.imgur.com/bfOhYma.png?2"></p>

<p>After successful application creation you will be redirected to application page where you will see <code>client ID</code> and <code>Client Secret</code> fields set for the application. They will be used later.</p>

<p>Add the bundle info in <code>composer.json</code> and issue <code>php composer.phar update --prefer-dist</code> command.</p>

<figure class='code'><figcaption><span>composer.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">require</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//...</span>
</span><span class='line'>        <span class="s2">&quot;friendsofsymfony/user-bundle&quot;</span><span class="o">:</span> <span class="s2">&quot;v1.3.2&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;hwi/oauth-bundle&quot;</span><span class="o">:</span> <span class="s2">&quot;0.3.*@dev&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enable the bundles in <code>app/AppKernel.php</code>,</p>

<figure class='code'><figcaption><span>app/AppKernel.php  </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$bundles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>        <span class="k">new</span> <span class="nx">FOS\UserBundle\FOSUserBundle</span><span class="p">(),</span>
</span><span class='line'>        <span class="k">new</span> <span class="nx">HWI\Bundle\OAuthBundle\HWIOAuthBundle</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now setup <code>FOSUserBundle</code>. For this tutorial I will only show user entity creation and configuration. For other setup <a href="https://github.com/FriendsOfSymfony/FOSUserBundle/blob/master/Resources/doc/index.md">refer to the documentation</a>.</p>

<p>In one  of your bundle add entity class with field information. After that add a entity field named <code>githubID</code> which maps to the github user id. Minimal entity class is given bellow.</p>

<figure class='code'><figcaption><span>src/YourVendor/YourBundle/Entity/User.php </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nx">YourVendor\YourBundle\Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">FOS\UserBundle\Entity\User</span> <span class="k">as</span> <span class="nx">BaseUser</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * @ORM\Entity</span>
</span><span class='line'><span class="sd"> * @ORM\Table(name=&quot;users&quot;)</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">BaseUser</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @ORM\Id</span>
</span><span class='line'><span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
</span><span class='line'><span class="sd">     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * @var string</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @ORM\Column(name=&quot;github_id&quot;, type=&quot;string&quot;, nullable=true)</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$githubID</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
</span><span class='line'>        <span class="c1">// your own logic</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Get id</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return integer </span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add routes of <code>FOSUserBundle</code> in <code>app/config/rouging.yml</code>. Please note that I am securing parts of the site that matches with <code>^/secure_area</code> url pattern. So appropriate prefix was added in this case. To apply it in root url just remove <code>/secure_area</code> portion in all  occurrences.</p>

<figure class='code'><figcaption><span>app/config/routing.yml   </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="nx">fos_user_security</span><span class="o">:</span>
</span><span class='line'>    <span class="nx">resource</span><span class="o">:</span> <span class="s2">&quot;@FOSUserBundle/Resources/config/routing/security.xml&quot;</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="o">:</span> <span class="o">/</span><span class="nx">secure_area</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fos_user_profile</span><span class="o">:</span>
</span><span class='line'>    <span class="nx">resource</span><span class="o">:</span> <span class="s2">&quot;@FOSUserBundle/Resources/config/routing/profile.xml&quot;</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="o">:</span> <span class="o">/</span><span class="nx">secure_area</span><span class="o">/</span><span class="nx">profile</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fos_user_register</span><span class="o">:</span>
</span><span class='line'>    <span class="nx">resource</span><span class="o">:</span> <span class="s2">&quot;@FOSUserBundle/Resources/config/routing/registration.xml&quot;</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="o">:</span> <span class="o">/</span><span class="nx">secure_area</span><span class="o">/</span><span class="nx">register</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fos_user_resetting</span><span class="o">:</span>
</span><span class='line'>    <span class="nx">resource</span><span class="o">:</span> <span class="s2">&quot;@FOSUserBundle/Resources/config/routing/resetting.xml&quot;</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="o">:</span> <span class="o">/</span><span class="nx">secure_area</span><span class="o">/</span><span class="nx">resetting</span>
</span><span class='line'>
</span><span class='line'><span class="nx">fos_user_change_password</span><span class="o">:</span>
</span><span class='line'>    <span class="nx">resource</span><span class="o">:</span> <span class="s2">&quot;@FOSUserBundle/Resources/config/routing/change_password.xml&quot;</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="o">:</span> <span class="o">/</span><span class="nx">secure_area</span><span class="o">/</span><span class="nx">profile</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add entity info in the <code>app/config/config.yml</code></p>

<figure class='code'><figcaption><span>app/config/config.yml  </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="n">fos_user</span><span class="p">:</span>
</span><span class='line'>    <span class="n">db_driver</span><span class="p">:</span> <span class="n">orm</span> <span class="c1"># other valid values are &#39;mongodb&#39;, &#39;couchdb&#39; and &#39;propel&#39;</span>
</span><span class='line'>    <span class="n">firewall_name</span><span class="p">:</span> <span class="n">secure_area</span>
</span><span class='line'>    <span class="n">user_class</span><span class="p">:</span> <span class="no">YourVendor</span><span class="p">\</span><span class="no">YourBundle</span><span class="p">\</span><span class="no">Entity</span><span class="p">\</span><span class="no">User</span>
</span><span class='line'>    <span class="ss">registration</span><span class="p">:</span>
</span><span class='line'>        <span class="ss">confirmation</span><span class="p">:</span>
</span><span class='line'>            <span class="ss">enabled</span><span class="p">:</span>    <span class="kp">false</span> <span class="c1"># change to true for required email confirmation</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in <code>app/config/security.yml</code> add <code>encoders</code> and <code>providers</code> information.</p>

<figure class='code'><figcaption><span>app/config/security.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">security</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">encoders</span><span class="p">:</span>
</span><span class='line'>        <span class="no">FOS</span><span class="p">\</span><span class="no">UserBundle</span><span class="p">\</span><span class="no">Model</span><span class="p">\</span><span class="ss">UserInterface</span><span class="p">:</span> <span class="n">sha512</span>
</span><span class='line'>    <span class="ss">providers</span><span class="p">:</span>
</span><span class='line'>        <span class="n">fos_userbundle</span><span class="p">:</span>
</span><span class='line'>            <span class="nb">id</span><span class="p">:</span> <span class="n">fos_user</span><span class="o">.</span><span class="n">user_provider</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now setup <code>HWIOauthBundle</code>. Add routes of <code>HWIOAuthBundle</code> to <code>app/config/routing.yml</code>.Another route named <code>hwi_github_login</code> was also added which is same as the callback url given during creation of Github application. This is the url which will be intercepted by the firewall to check authentication.</p>

<figure class='code'><figcaption><span>app/config/routing.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">hwi_oauth_redirect</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">resource</span><span class="p">:</span> <span class="s2">&quot;@HWIOAuthBundle/Resources/config/routing/redirect.xml&quot;</span>
</span><span class='line'>    <span class="ss">prefix</span><span class="p">:</span>   <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>
</span><span class='line'><span class="n">hwi_oauth_login</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">resource</span><span class="p">:</span> <span class="s2">&quot;@HWIOAuthBundle/Resources/config/routing/login.xml&quot;</span>
</span><span class='line'>    <span class="ss">prefix</span><span class="p">:</span>   <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>
</span><span class='line'><span class="n">hwi_oauth_connect</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">resource</span><span class="p">:</span> <span class="s2">&quot;@HWIOAuthBundle/Resources/config/routing/connect.xml&quot;</span>
</span><span class='line'>    <span class="ss">prefix</span><span class="p">:</span>   <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>
</span><span class='line'><span class="n">hwi_github_login</span><span class="p">:</span>
</span><span class='line'>    <span class="ss">pattern</span><span class="p">:</span> <span class="sr">/secure_area/</span><span class="n">login</span><span class="o">/</span><span class="n">check</span><span class="o">-</span><span class="n">github</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now setup the security firewall.</p>

<figure class='code'><figcaption><span>app/config/security.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">security</span><span class="p">:</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>    <span class="ss">firewalls</span><span class="p">:</span>
</span><span class='line'>        <span class="c1">#...</span>
</span><span class='line'>        <span class="n">secure_area</span><span class="p">:</span>
</span><span class='line'>            <span class="ss">pattern</span><span class="p">:</span> <span class="o">^/</span><span class="n">secure_area</span>
</span><span class='line'>
</span><span class='line'>            <span class="ss">oauth</span><span class="p">:</span>
</span><span class='line'>                <span class="n">failure_path</span><span class="p">:</span> <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>                <span class="n">login_path</span><span class="p">:</span> <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>                <span class="n">check_path</span><span class="p">:</span> <span class="sr">/secure_area/</span><span class="n">connect</span>
</span><span class='line'>                <span class="ss">provider</span><span class="p">:</span> <span class="n">fos_userbundle</span>
</span><span class='line'>                <span class="n">resource_owners</span><span class="p">:</span>
</span><span class='line'>                    <span class="ss">github</span><span class="p">:</span>           <span class="s2">&quot;/secure_area/login/check-github&quot;</span>
</span><span class='line'>                <span class="n">oauth_user_provider</span><span class="p">:</span>
</span><span class='line'>                    <span class="ss">service</span><span class="p">:</span> <span class="n">hwi_oauth</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">fosub_bridge</span>
</span><span class='line'>
</span><span class='line'>            <span class="ss">anonymous</span><span class="p">:</span>    <span class="kp">true</span>
</span><span class='line'>            <span class="ss">logout</span><span class="p">:</span>
</span><span class='line'>                <span class="ss">path</span><span class="p">:</span>           <span class="sr">/secure_area/</span><span class="n">logout</span>
</span><span class='line'>                <span class="ss">target</span><span class="p">:</span>         <span class="sr">/secure_area/</span><span class="n">connect</span> <span class="c1">#where to go after logout</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">access_control</span><span class="p">:</span>
</span><span class='line'>        <span class="c1">#....</span>
</span><span class='line'>        <span class="o">-</span> <span class="p">{</span> <span class="ss">path</span><span class="p">:</span> <span class="o">^/</span><span class="n">secure_area</span><span class="o">/</span><span class="n">login</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="no">IS_AUTHENTICATED_ANONYMOUSLY</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">-</span> <span class="p">{</span> <span class="ss">path</span><span class="p">:</span> <span class="o">^/</span><span class="n">secure_area</span><span class="o">/</span><span class="n">connect</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="no">IS_AUTHENTICATED_ANONYMOUSLY</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">-</span> <span class="p">{</span> <span class="ss">path</span><span class="p">:</span> <span class="o">^/</span><span class="n">secure_area</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="no">ROLE_USER</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <code>firewalls</code> section a new firewall named <code>secure_area</code> with OAuth provider named <code>oauth</code> is added which handles <code>^/secure_area</code> url pattern. In <code>resource_owners</code> section of the OAuth provider intercept url for the Github resource owner is provided. It is same as the callback url given during Github application creation.</p>

<p>In later <code>access_control</code> section path matching <code>^/secure_area/connect</code> and <code>^/secure_area/login</code> pattern moved out of secure area.</p>

<p>User provider of the OAuth authentication provider is <code>fos_userbundle</code> which was setup previously. As user provider is <code>FOSUserBundle</code>, built-in <code>hwi_oauth.user.provider.fosub_bridge</code> service was set as <code>oauth_user_provider</code>. If you want to set it to your custom user provider you have to implement <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Security/Core/User/OAuthAwareUserProviderInterface.php">OAuthAwareUserProviderInterface</a>.</p>

<p>Now setup <code>app/config/config.yml</code>.</p>

<figure class='code'><figcaption><span>app/config/config.yml   </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="n">hwi_oauth</span><span class="p">:</span>
</span><span class='line'>    <span class="c1"># name of the firewall in which this bundle is active, this setting MUST be set</span>
</span><span class='line'>    <span class="n">firewall_name</span><span class="p">:</span> <span class="n">secure_area</span>
</span><span class='line'>    <span class="ss">connect</span><span class="p">:</span>
</span><span class='line'>        <span class="ss">confirmation</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>        <span class="c1">#account_connector: hwi_oauth.user.provider.fosub_bridge</span>
</span><span class='line'>        <span class="c1">#registration_form_handler: hwi_oauth.registration.form.handler.fosub_bridge</span>
</span><span class='line'>        <span class="c1">#registration_form: fos_user.registration.form</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resource_owners</span><span class="p">:</span>
</span><span class='line'>        <span class="ss">github</span><span class="p">:</span>
</span><span class='line'>            <span class="ss">type</span><span class="p">:</span>                <span class="n">github</span>
</span><span class='line'>            <span class="n">client_id</span><span class="p">:</span>           <span class="o">&lt;</span><span class="n">client_id</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="n">client_secret</span><span class="p">:</span>       <span class="o">&lt;</span><span class="n">client_secret</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="ss">scope</span><span class="p">:</span>               <span class="s2">&quot;user:email&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="ss">fosub</span><span class="p">:</span>
</span><span class='line'>        <span class="c1"># try 30 times to check if a username is available (foo, foo1, foo2 etc)</span>
</span><span class='line'>        <span class="n">username_iterations</span><span class="p">:</span> <span class="mi">30</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># mapping between resource owners (see below) and properties</span>
</span><span class='line'>        <span class="ss">properties</span><span class="p">:</span>
</span><span class='line'>            <span class="ss">github</span><span class="p">:</span> <span class="n">githubID</span>
</span></code></pre></td></tr></table></div></figure>


<p>The value of <code>firewall_name</code> is same as the name of the firewall with OAuth provider setup in <code>app/config/security.yml</code>.</p>

<p>In <code>resource_owners</code> section OAuth information were added. The value of <code>client_id</code> and <code>client_secret</code> are the values set by Github after the creation of the application. For configuration of other resource owners <a href="https://github.com/hwi/HWIOAuthBundle/tree/master/Resources/doc/resource_owners">see the documentation</a>.</p>

<p>Since <code>FOSUserBundle</code> were used as user provider, <code>fosub</code> section were added. In <code>properties</code> section <code>githubID</code> entity field was set as value of <code>github</code> config field.</p>

<p>The <code>connect</code> section connects <code>HWIOAuthBundle</code> to the registration system of Symfony. It also links existing logged in users to the authenticated service. Note that simply adding <code>connect: ~</code> would be enough to link <code>HWIOAuthBundle</code> to the registration system. For the brief explanation of the options I have added default values.</p>

<p>If <code>confirmation</code> option is set to true, user will be shown a  page that will ask the user to connect the current authenticated resource to existing logged in user account. The template location is <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Resources/views/Connect/connect_confirm.html.twig">HWIOAuthBundle:Connect:connect_confirm.html.twig</a>. To override the template <a href="http://symfony.com/doc/current/book/templating.html#overriding-bundle-templates">see the documentation</a>.</p>

<p>The value of <code>account_connector</code> is a user provider class that implements <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Connect/AccountConnectorInterface.php">AccountConnectorInterFace</a>. By default it is set to same <code>hwi_oauth.user.provider.fosub_bridge</code> service that was set in OAuth firewall. So if you want to add support for your custom user provider you have to extend it so that it implements <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Connect/AccountConnectorInterface.php">AccountConnectorInterFace</a> and <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Security/Core/User/OAuthAwareUserProviderInterface.php">OAuthAwareUserProviderInterface</a>.</p>

<p>The <code>registration_form_handler</code> is set to <code>hwi_oauth.registration.form.handler.fosub_bridge</code> service. It is used during registration process and does almost same thing as default <code>FOSUserBundle</code> registration form handler. The difference is that it implements <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Form/RegistrationFormHandlerInterface.php">RegistrationFormHandlerInterface</a>. So if you want to add your custom handler you have to extend the handler to implement <code>RegistrationFormHandlerInterface</code>.</p>

<p>The value of <code>registration_form</code> is same as default <code>FOSUserBundle</code> registration form <code>fos_user.registration.form</code>. It is used during registration operation. The twig template of the registration file is at <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Resources/views/Connect/registration.html.twig">HWIOAuthBundle:Connect:registration.html.twig</a>. Override it to meet your requirement.</p>

<p>Then issue following commands which will generate entity setter/getter methods and save table information to DB.</p>

<figure class='code'><figcaption><span>command </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> php app/console doctrine:generate:entities YourVendorYourBundle
</span><span class='line'> php app/console doctrine:schema:update --force
</span></code></pre></td></tr></table></div></figure>


<p>Thats all. Now go to any url matcing <code>^/sceure_area</code> pattern and you will be redirected to <code>/secure_area/connect</code> url where lists of OAuth resource owners will be shown. The twig template of the page is <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Resources/views/Connect/login.html.twig">HWIOAuthBundle:Connect:login.html.twig</a>. Override it to meet your requirement. After successful OAuth authentication new user will be redirected to registration page or to previous page if the user already exists.</p>

<p>Once first resource owner is configured adding other resource owners is very easy. Just add mapping resource owners field in the entity, add check-resource route on <code>app/config/routng.yml</code>, add client id and client secret to <code>app/config/config.yml</code>, add property mapping and add another line in <code>resource_owners</code> section of the <code>app/config/security.yml</code>.</p>

<p>Another bonus tip, After successful authentication you can get access token of the resource from the toke of the <code>security.context</code> service as <code>HWIOAuthBundle</code> sets <a href="https://github.com/hwi/HWIOAuthBundle/blob/master/Security/Core/Authentication/Token/OAuthToken.php#L22">OAuthToken</a> after successful authentication. So just by adding following line</p>

<figure class='code'><figcaption><span>YourController.php </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'>    <span class="nv">$accessToken</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;security.context&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getAccessToken</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>will give you the access token with which you can do REST API call to the resource.</p>

<p>I have combined code example of this post and my <a href="http://m2mdas.github.io/blog/2013/11/18/integrate-fosuserbundle-and-sonatauserbundle-easily/">previous post</a> and uploaded to <a href="https://github.com/m2mdas/MinimalSecurityBundlesSetup">Github</a>. It integrates <code>FOSUserBundle</code>, <code>SonataAdminBundle</code>, <code>SonataUserBundle</code> and <code>HWIOAuthBundle</code>. Enjoy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/18/integrate-fosuserbundle-and-sonatauserbundle-easily/">Integrate FOSUserBundle and SonataUserBundle Easily</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-18T05:41:00+06:00" pubdate data-updated="true">Nov 18<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/sonata-project/SonataUserBundle">SonataUserBundle</a> is a great extension of <a href="https://github.com/sonata-project/SonataAdminBundle">SonataAdminBundle</a> that provides user administration features by integrating <a href="https://github.com/FriendsOfSymfony/FOSUserBundle">FOSUserBundle</a> user provider/management bundle. Its <a href="https://github.com/sonata-project/SonataUserBundle/blob/master/Resources/doc/reference/installation.rst#installation">default installation procedure</a> recommends to setup <code>SonataUserBundle</code> as child bundle of <code>FOSUserBundle</code> and generate <code>ApplicationSonataUserBundle</code> via <code>sonata:easy-extends:generate</code> command. But on some cases you may not want to setup that way. For example you have setup your user entity by following the documentation of <code>FOSUserBundle</code> before integrating <code>SonataAdminBundle</code> and <code>SonataUserBundle</code>, you may want to override both bundles separately.  In following section I will outline how to integrate <code>SonataUserBundle</code> with <code>FOSUserBundle</code> without creating child bundle of <code>FOSUserBundle</code>.</p>

<p>Default installation and setup of <code>FOSUserBundle</code> is same as <a href="https://github.com/FriendsOfSymfony/FOSUserBundle/blob/master/Resources/doc/index.md#getting-started-with-fosuserbundle">stated in default documentation</a>. Then install and setup <code>SonataAdminBundle</code> <a href="http://sonata-project.org/bundles/admin/master/doc/index.html#reference-guide">according to its documentation</a>. Both guides are pretty well documented. So I will not duplicate them here.</p>

<p>Now setup <code>SonataUserBundle</code>. Add it to <code>composer.json</code> and add following line into <code>registerBundle</code> method of <code>app/AppKernel.php</code></p>

<figure class='code'><figcaption><span>app/AppKernel.php </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// app/AppKernel.php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$bundles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="c1">// other bundle declarations</span>
</span><span class='line'>        <span class="k">new</span> <span class="nx">Sonata\UserBundle\SonataUserBundle</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then setup configuration, add routing and security configuration according to <a href="https://github.com/sonata-project/SonataUserBundle/blob/master/Resources/doc/reference/installation.rst#configuration">the documentation</a>.</p>

<p>Now set value of <code>sonata.user.admin.user.class</code> parameter to the FQCN of the User entity which was created during <code>FOSUserBundle</code> setup. For example if FQCN of your user entity is <code>YourVendor\YourBundle\Entity\User</code> then parameter setting of <code>app/config.yml</code> would be</p>

<figure class='code'><figcaption><span>app/config/config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">parameters</span><span class="p">:</span>
</span><span class='line'>    <span class="c1">#....</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">entity</span><span class="p">:</span> <span class="no">YourVendor</span><span class="p">\</span><span class="no">YourBundle</span><span class="p">\</span><span class="no">Entity</span><span class="p">\</span><span class="no">User</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now create a class that extends default <a href="https://github.com/sonata-project/SonataUserBundle/blob/master/Admin/Model/UserAdmin.php">UserAdmin</a> class and override <code>configureShowFields</code>, <code>configureFormFields</code>, <code>configureDatagridFilters</code> and <code>configureListFields</code> methods to add the needed user admin fields. Following is the sample extended <code>UserAdmin</code> class which is based on the bare bone user entity created in <code>FOSUserBundle</code> documentation.</p>

<figure class='code'><figcaption><span>src/YourVendor/YourBundle/Admin/UserAdmin.php  </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="c1">//src/YourVendor/YourBundle/Admin/UserAdmin.php</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nx">YourVendor\YourBundle\Admin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\UserBundle\Admin\Model\UserAdmin</span> <span class="k">as</span> <span class="nx">BaseUserAdmin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\AdminBundle\Form\FormMapper</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\AdminBundle\Datagrid\DatagridMapper</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\AdminBundle\Datagrid\ListMapper</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\AdminBundle\Show\ShowMapper</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="nx">FOS\UserBundle\Model\UserManagerInterface</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nx">Sonata\AdminBundle\Route\RouteCollection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAdmin</span> <span class="k">extends</span> <span class="nx">BaseUserAdmin</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * {@inheritdoc}</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">configureShowFields</span><span class="p">(</span><span class="nx">ShowMapper</span> <span class="nv">$showMapper</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$showMapper</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span>
</span><span class='line'>            <span class="c1">// .. more info</span>
</span><span class='line'>        <span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * {@inheritdoc}</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">configureFormFields</span><span class="p">(</span><span class="nx">FormMapper</span> <span class="nv">$formMapper</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$formMapper</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;plainPassword&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span>
</span><span class='line'>            <span class="c1">// .. more info</span>
</span><span class='line'>            <span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getSubject</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasRole</span><span class="p">(</span><span class="s1">&#39;ROLE_SUPER_ADMIN&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$formMapper</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;Management&#39;</span><span class="p">)</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="s1">&#39;sonata_security_roles&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>                        <span class="s1">&#39;expanded&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;multiple&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                        <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span>
</span><span class='line'>                    <span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;locked&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;expired&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;credentialsExpired&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span>
</span><span class='line'>            <span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * {@inheritdoc}</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">configureDatagridFilters</span><span class="p">(</span><span class="nx">DatagridMapper</span> <span class="nv">$filterMapper</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$filterMapper</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;locked&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * {@inheritdoc}</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">configureListFields</span><span class="p">(</span><span class="nx">ListMapper</span> <span class="nv">$listMapper</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$listMapper</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">addIdentifier</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">))</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;locked&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">))</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;createdAt&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isGranted</span><span class="p">(</span><span class="s1">&#39;ROLE_ALLOWED_TO_SWITCH&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$listMapper</span>
</span><span class='line'>                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;impersonating&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;template&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;SonataUserBundle:Admin:Field/impersonating.html.twig&#39;</span><span class="p">))</span>
</span><span class='line'>            <span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now set the value of <code>sonata.user.admin.user.class</code> to the FQCN of the created <code>UserAdmin</code> class in <code>app/config/config.yml</code>, e.g</p>

<figure class='code'><figcaption><span>app/config/config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/config/config.yml</span>
</span><span class='line'>
</span><span class='line'><span class="ss">parameters</span><span class="p">:</span>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">class</span><span class="p">:</span> <span class="no">YourVendor</span><span class="p">\</span><span class="no">YourBundle</span><span class="p">\</span><span class="no">Admin</span><span class="p">\</span><span class="no">UserAdmin</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ....</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t need user group functionality you can disable it. e.g in your <code>app/config/config.yml</code> add following lines.</p>

<figure class='code'><figcaption><span>app/config/config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/config/config.yml</span>
</span><span class='line'>
</span><span class='line'><span class="ss">services</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
</span><span class='line'>        <span class="ss">abstract</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>        <span class="kp">public</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Combined <code>config.yml</code> setting given bellow,</p>

<figure class='code'><figcaption><span>app/config/config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/config/config.yml</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#...</span>
</span><span class='line'>
</span><span class='line'><span class="ss">parameters</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">class</span><span class="p">:</span> <span class="no">YourVendor</span><span class="p">\</span><span class="no">YourBundle</span><span class="p">\</span><span class="no">Admin</span><span class="p">\</span><span class="no">UserAdmin</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">entity</span><span class="p">:</span> <span class="no">YourVendor</span><span class="p">\</span><span class="no">YourBundle</span><span class="p">\</span><span class="no">Entity</span><span class="p">\</span><span class="no">User</span>
</span><span class='line'>
</span><span class='line'><span class="ss">services</span><span class="p">:</span>
</span><span class='line'>    <span class="n">sonata</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
</span><span class='line'>        <span class="ss">abstract</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>        <span class="kp">public</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'><span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>If everything setup correctly you will see an new users row in <code>admin/dashboard</code> page. All user operations should work as expected. Thats all for now.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/21/integrate-hwioauthbundle-with-fosuserbundle/">Integrate HWIOAuthBundle With FOSUserBundle</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/integrate-fosuserbundle-and-sonatauserbundle-easily/">Integrate FOSUserBundle and SonataUserBundle Easily</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Stack Overflow</h1>
  <a href="http://stackoverflow.com/users/1218997/m2mdas">
  <img src="http://stackoverflow.com/users/flair/1218997.png" width="208" height="58" alt="profile for m2mdas at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for m2mdas at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/m2mdas">@m2mdas</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'm2mdas',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Mun Mun Das -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'm2mdas';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
